<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Persistency Estimator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #1d1d1f;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 600px;
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    input, select, textarea {
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 90%;
      font-size: 16px;
      display: block;
    }
    button {
      background: #0071e3;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      width: 90%;
    }
    button:hover {
      background: #005bb5;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
      font-size: 18px;
      text-align: left;
    }

    .guide {
      text-align: left;
      background: #eef4ff;
      border: 1px solid #0071e3;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }

    .collapsible {
      background-color: #0071e3;
      color: white;
      cursor: pointer;
      padding: 12px 20px;
      width: 100%;
      border: none;
      border-radius: 8px;
      text-align: left;
      outline: none;
      font-size: 16px;
    }

    .collapsible.active {
      background-color: #005bb5;
    }

    .chatgpt-prompt {
      background: #fff;
      border: 1px dashed #0071e3;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    @media (max-width: 480px) {
      input, select, button, textarea {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Persistency Calculator</h2>

    <select id="persistencyType">
      <option value="12">12-Month Persistency</option>
      <option value="13">13-Month Persistency</option>
    </select>

    <textarea id="textInput" rows="10" placeholder="Paste extracted policy data here..."></textarea>

    <button onclick="calculate()">Calculate</button>

    <button class="collapsible" onclick="toggleGuide(this)">Show Guide</button>
    <div class="guide" id="guideSection">
      <strong>Step 1:</strong> Open your Manulife PDF report.<br><br>
      <strong>Step 2:</strong> Use your ChatGPT app to extract the correct format.<br><br>
      <strong>Step 3:</strong> Paste the following prompt into ChatGPT:
      <div class="chatgpt-prompt">
Please extract the following details from the copied Manulife report:

Format:  
PolicyNo, Name, MonthsPaid, PsistANP, Status, PersistencyBlock, ReportDate  

Example:  
00915703, CHEAH YU JUN, 10, 3,600.00, LC, 01-JUN-2023 to 31-MAY-2024, 11/07/2025  

Notes:  
- Only include actual policies (skip totals or headers)  
- PersistencyBlock = date range near top  
- ReportDate = date at top-left corner
      </div><br>
      <strong>Step 4:</strong> Copy the result from ChatGPT and paste it into the input box above.
    </div>

    <div id="result"></div>
  </div>

  <script>
    function toggleGuide(button) {
      const guide = document.getElementById("guideSection");
      guide.style.display = guide.style.display === "block" ? "none" : "block";
      button.classList.toggle("active");
    }

    function formatRM(value) {
      return "RM" + parseFloat(value).toLocaleString("en-MY", { minimumFractionDigits: 2 });
    }

    function getFriendlyStatus(status) {
      const map = {
        "IP": "IP (inforce)",
        "LC": "LC (lapsed)",
        "LA": "LA (lapsed)",
        "TC": "TC (surrendered)"
      };
      return map[status] || status;
    }

    function calculate() {
      const raw = document.getElementById("textInput").value.trim();
      const lines = raw.split("\n").filter(line => line.trim() && !line.startsWith("PolicyNo"));

      const persistencyType = parseInt(document.getElementById("persistencyType").value);

      let totalANP = 0;
      let qualifiedANP = 0;
      let saveable = [];
      let unqualified = [];

      const rows = lines.map(line => {
        const [policy, name, months, anp, status, block, date] = line.split(",").map(x => x.trim());
        const monthsPaid = parseInt(months);
        const anpVal = parseFloat(anp.replace(/,/g, '')) || 0;

        totalANP += anpVal;

        const isQualified = monthsPaid >= persistencyType;
        if (isQualified) {
          qualifiedANP += anpVal;
        } else {
          unqualified.push({ policy, name, monthsPaid, anpVal, status });
          if (["IP", "LC", "LA", "TC"].includes(status)) {
            saveable.push({ policy, name, monthsPaid, anpVal, status });
          }
        }

        return { policy, name, monthsPaid, anpVal, status, block, date };
      });

      // Sort saveable by status priority
      const statusRank = { IP: 1, LC: 2, LA: 2, TC: 3 };
      saveable.sort((a, b) => statusRank[a.status] - statusRank[b.status]);

      const percent = totalANP ? ((qualifiedANP / totalANP) * 100).toFixed(1) : "0.0";

      let html = `
        <p><strong>Total Psist ANP:</strong> ${formatRM(totalANP)}</p>
        <p><strong>Qualified Psist ANP:</strong> ${formatRM(qualifiedANP)}</p>
        <p><strong>Persistency %:</strong> ${percent}%</p>
      `;

      if (saveable.length) {
        html += `<h3>Saveable Policies:</h3><ul style="text-align:left">`;
        for (let s of saveable) {
          html += `<li>${s.policy} - ${s.name}, ${s.monthsPaid} months paid, ${formatRM(s.anpVal)} - Status: ${getFriendlyStatus(s.status)}</li>`;
        }
        html += `</ul>`;
      }

      if (unqualified.length) {
        html += `<h3>Unqualified Policies (Below ${persistencyType} months):</h3><ul style="text-align:left">`;
        for (let u of unqualified) {
          html += `<li>${u.policy} - ${u.name}, ${u.monthsPaid} months paid, ${formatRM(u.anpVal)} - Status: ${getFriendlyStatus(u.status)}</li>`;
        }
        html += `</ul>`;
      }

      document.getElementById("result").innerHTML = html;
    }
  </script>
</body>
</html>
